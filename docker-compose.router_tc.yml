version: '3.8'

services:
  http3-server:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: http3-server
    restart: unless-stopped
    # ポートを直接公開（クライアント→サーバー直接通信）
    ports:
      - "8443:8443/tcp" # HTTP/1.1, HTTP/2用
      - "8443:8443/udp" # HTTP/3用
      - "8444:8444/tcp" # HTTP/2用（実機環境との互換性のため）
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 65536
        hard: 65536
    cap_add:
      - NET_ADMIN
    cpuset: "0"
    cpu_shares: 2048
    environment:
      - BANDWIDTH=${BANDWIDTH:-5mbit}
      - LATENCY=${LATENCY:-0ms}
      - LOSS=${LOSS:-0%}
    networks:
      - protocol_net

networks:
  protocol_net:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500
