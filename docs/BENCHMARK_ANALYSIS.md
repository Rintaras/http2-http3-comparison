# 遅延影響ベンチマーク結果の分析と評価

## 実験概要

**実験日時**: 2025年10月1日 17:12:22
**データファイル**: benchmark_results_20251001_171222.csv

### 実験条件
- **帯域**: 5Mbps (固定)
- **遅延**: 0ms, 50ms, 100ms, 150ms
- **パケット損失**: 0% (固定)
- **データサイズ**: 1MB (固定)
- **リクエスト数**: 各条件50回
- **総リクエスト数**: 400回 (4条件 × 2プロトコル × 50回)

---

## 結果サマリー

### 全条件での成功率
- **HTTP/2**: 200/200 (100%)
- **HTTP/3**: 200/200 (100%)

両プロトコルとも全条件で100%の成功率を達成 ✅

### 統計データ

| 遅延 | プロトコル | 平均時間(秒) | 中央値(秒) | 標準偏差 | 平均速度(KB/s) |
|------|-----------|------------|-----------|---------|---------------|
| **0ms** | HTTP/2 | 1.763 | 1.762 | 0.036 | 581.19 |
| **0ms** | HTTP/3 | 1.859 | 1.857 | 0.014 | 550.71 |
| **50ms** | HTTP/2 | 2.166 | 2.165 | 0.013 | 472.68 |
| **50ms** | HTTP/3 | 2.160 | 2.134 | 0.102 | 474.86 |
| **100ms** | HTTP/2 | 2.592 | 2.580 | 0.049 | 395.17 |
| **100ms** | HTTP/3 | 2.592 | 2.550 | 0.104 | 395.64 |
| **150ms** | HTTP/2 | 3.042 | 3.036 | 0.034 | 336.67 |
| **150ms** | HTTP/3 | 3.015 | 3.010 | 0.025 | 339.65 |

---

## 詳細分析

### 1. 遅延 0ms（ベースライン環境）

**結果:**
- HTTP/2: 1.763秒（581 KB/s）
- HTTP/3: 1.859秒（551 KB/s）

**評価:**
- ✅ **HTTP/2が5.4%高速**（96ms速い）
- HTTP/2の標準偏差: 0.036（非常に安定）
- HTTP/3の標準偏差: 0.014（極めて安定）
- HTTP/3は一貫性が高いが、わずかに遅い

**考察:**
- 低遅延環境ではHTTP/2のTCP最適化が有効
- HTTP/3のQUICオーバーヘッド（暗号化・輻輳制御）が影響
- UDPバッファサイズ制限の影響あり（416 kiB）

**結論:** 低遅延・高帯域環境ではHTTP/2が優位 ⭐

---

### 2. 遅延 50ms（国内ネットワーク相当）

**結果:**
- HTTP/2: 2.166秒（473 KB/s）
- HTTP/3: 2.160秒（475 KB/s）

**評価:**
- ✅ **HTTP/3が0.3%高速**（6ms速い）
- **ほぼ同等の性能**
- HTTP/2の標準偏差: 0.013（極めて安定）
- HTTP/3の標準偏差: 0.102（やや変動あり）

**考察:**
- 遅延50msでプロトコル差がほぼ消失
- HTTP/3の平均は速いが、ばらつきが大きい
- 中央値で見るとHTTP/3が2.134秒で有利（31ms速い）

**結論:** 中程度遅延環境では同等、HTTP/3がわずかに優位 ⭐

---

### 3. 遅延 100ms（国際ネットワーク相当）

**結果:**
- HTTP/2: 2.592秒（395 KB/s）
- HTTP/3: 2.592秒（396 KB/s）

**評価:**
- ✅ **完全に同等**（平均で同一）
- HTTP/2の標準偏差: 0.049
- HTTP/3の標準偏差: 0.104（2倍のばらつき）
- 中央値ではHTTP/3が2.550秒で有利（30ms速い）

**考察:**
- 平均値は同一だが、HTTP/3の分散が大きい
- QUICの輻輳制御の挙動が不安定
- 中央値で評価すればHTTP/3が優位

**結論:** 高遅延環境では同等、ただしHTTP/3の安定性に課題 ⚠️

---

### 4. 遅延 150ms（長距離国際ネットワーク相当）

**結果:**
- HTTP/2: 3.042秒（337 KB/s）
- HTTP/3: 3.015秒（340 KB/s）

**評価:**
- ✅ **HTTP/3が0.9%高速**（27ms速い）
- HTTP/2の標準偏差: 0.034（安定）
- HTTP/3の標準偏差: 0.025（やや安定）
- 中央値でもHTTP/3が26ms速い

**考察:**
- 高遅延環境でHTTP/3の優位性が現れ始める
- QUICの改善された輻輳制御が機能
- 両プロトコルとも安定した性能

**結論:** 非常に高遅延環境ではHTTP/3が優位 ⭐⭐

---

## 総合評価

### 1. 性能比較（平均転送時間）

```
遅延     HTTP/2   HTTP/3   差分      勝者
────────────────────────────────────────
0ms      1.763秒  1.859秒  +96ms    HTTP/2 ✓
50ms     2.166秒  2.160秒  -6ms     HTTP/3 ✓
100ms    2.592秒  2.592秒   0ms     同等   =
150ms    3.042秒  3.015秒  -27ms    HTTP/3 ✓
────────────────────────────────────────
総合評価: HTTP/2 1勝, HTTP/3 2勝, 引き分け 1
```

### 2. 遅延の影響

#### HTTP/2の遅延増加
- 0ms → 50ms: +403ms (+22.9%)
- 50ms → 100ms: +426ms (+19.7%)
- 100ms → 150ms: +450ms (+17.4%)

#### HTTP/3の遅延増加
- 0ms → 50ms: +301ms (+16.2%)
- 50ms → 100ms: +432ms (+20.0%)
- 100ms → 150ms: +423ms (+16.3%)

**考察:**
- HTTP/3は低遅延→中遅延の影響が小さい（16.2% vs 22.9%）
- 100ms以降は両プロトコルでほぼ同じ増加率
- HTTP/3の初期ハンドシェイク統合が低遅延で有効

### 3. 安定性比較（標準偏差）

```
遅延     HTTP/2   HTTP/3   安定性
────────────────────────────────────
0ms      0.036    0.014    HTTP/3 ✓✓
50ms     0.013    0.102    HTTP/2 ✓✓
100ms    0.049    0.104    HTTP/2 ✓
150ms    0.034    0.025    HTTP/3 ✓
────────────────────────────────────
```

**考察:**
- 低遅延（0ms）ではHTTP/3が最も安定
- 中遅延（50ms-100ms）ではHTTP/3のばらつきが大きい
- 高遅延（150ms）では両プロトコルとも安定

---

## 重要な発見

### 1. クロスオーバーポイント

**遅延約45-50msでHTTP/2とHTTP/3の性能が逆転**

- **0-45ms**: HTTP/2が優位
- **45-50ms**: ほぼ同等
- **50ms以上**: HTTP/3がわずかに優位

### 2. HTTP/3の課題

#### 低遅延環境での劣勢
- 0ms環境で5.4%遅い（96ms差）
- QUICのオーバーヘッドが顕在化
- UDPバッファサイズ制限の影響

#### 中遅延環境での不安定性
- 50ms環境で標準偏差が7.8倍大きい
- 100ms環境でも2.1倍大きい
- 輻輳制御の調整が不安定

### 3. HTTP/2の強み

#### 低遅延環境での優位性
- TCPの成熟した実装
- カーネル最適化の恩恵
- 安定した性能

#### 一貫した安定性
- ほぼすべての条件で低い標準偏差
- 予測可能な性能

---

## 理論的考察

### 1. なぜHTTP/3は低遅延で劣るのか？

#### QUICのオーバーヘッド
- **ユーザー空間実装**: TCPはカーネル空間で最適化
- **暗号化統合**: すべてのパケットで暗号処理
- **パケット番号空間**: TCP ACKより複雑
- **輻輳制御**: ユーザー空間での実装オーバーヘッド

#### UDPの制約
- **バッファサイズ**: 416 kiB（推奨2048 kiBの20%）
- **カーネル最適化不足**: UDPはTCPほど最適化されていない
- **フロー制御**: アプリケーション層での実装

### 2. なぜHTTP/3は高遅延で優位なのか？

#### 1-RTTハンドシェイク
- **TLS統合**: TLSハンドシェイクが不要
- **接続確立**: TCP SYN/ACK + TLS ClientHello/ServerHelloが1往復に

理論的遅延削減:
```
HTTP/2: RTT × 2 (TCP + TLS)
HTTP/3: RTT × 1 (QUIC統合)
```

150ms環境での理論値:
- HTTP/2のハンドシェイク: 300ms
- HTTP/3のハンドシェイク: 150ms
- **削減: 150ms**

実測での削減: 27ms（理論値の18%）

**考察**: ハンドシェイク以外の要因が支配的

#### HOL（Head-of-Line）ブロッキング回避
- **今回のテスト**: 単一リクエストのため効果なし
- **複数ストリーム**: HTTP/3が大きく優位なはず

---

## 実用的な推奨事項

### 1. ネットワーク条件別の選択

| 環境 | 遅延 | 推奨プロトコル | 理由 |
|------|-----|--------------|------|
| **LAN/データセンター内** | 0-20ms | **HTTP/2** | 5%高速、安定 |
| **国内ネットワーク** | 20-80ms | **同等** | どちらでも可 |
| **国際ネットワーク** | 80ms以上 | **HTTP/3** | わずかに高速 |
| **モバイル（4G/5G）** | 変動大 | **HTTP/3** | コネクション移行 |

### 2. ユースケース別の選択

#### HTTP/2が優位なケース
- ✅ 低遅延環境（データセンター間通信）
- ✅ 単一大容量ファイル転送
- ✅ 安定性最優先
- ✅ 既存インフラ活用

#### HTTP/3が優位なケース
- ✅ 高遅延環境（国際通信）
- ✅ モバイルネットワーク
- ✅ 複数小ファイルの並列転送
- ✅ コネクション移行が必要

#### どちらでも良いケース
- 中程度の遅延（30-100ms）
- 単一接続での転送
- 安定したネットワーク

### 3. ハイブリッド戦略

**推奨アプローチ:**
1. HTTP/3をプライマリとして提供（Alt-Svcヘッダー）
2. HTTP/2をフォールバックとして維持
3. クライアントに選択させる

**実装例:**
```
Alt-Svc: h3=":443"; ma=86400
```

---

## 今回のベンチマークの限界

### 1. 測定条件の制約

#### 単一リクエストのみ
- HTTP/3の多重化優位性が未評価
- HOLブロッキング回避の効果が未測定

#### 固定ファイルサイズ（1MB）
- 小ファイル・大ファイルでの挙動が不明
- ハンドシェイクオーバーヘッドの相対的影響が異なる

#### パケット損失なし
- QUICの再送制御優位性が未評価
- 実ネットワークでは損失があるのが普通

### 2. 環境の制約

#### macOS + Docker
- Linuxカーネルより非効率
- VMオーバーヘッドあり

#### UDPバッファサイズ制限
- 416 kiB（推奨の20%）
- HTTP/3の性能を制限

#### ローカルループバック
- 実WANとは特性が異なる
- ジッター・輻輳がない

---

## 改善提案

### 1. 追加実験

#### 複数ファイル並列転送
```bash
# 10個の100KBファイルを並列転送
for i in {1..10}; do
  curl -parallel https://server/file$i
done
```

#### パケット損失環境
```bash
BANDWIDTH=5mbit LATENCY=50ms LOSS=1% 
```

#### ファイルサイズ変動
- 10KB, 100KB, 1MB, 10MB, 100MB

### 2. 測定項目の追加

- ハンドシェイク時間の分離測定
- CPU使用率
- メモリ使用量
- 再送回数

### 3. 環境の改善

- Linux環境での実験
- 物理マシン間の実験
- UDPバッファサイズの最適化
- 実WAN環境でのテスト

---

## 結論

### 主要な発見

1. **低遅延環境（0-45ms）**: HTTP/2が5%高速 ⭐⭐
2. **中遅延環境（45-100ms）**: ほぼ同等 ⭐
3. **高遅延環境（100ms以上）**: HTTP/3がわずかに優位 ⭐

### 実用的な結論

**「遅延50msがターニングポイント」**

- **50ms未満**: HTTP/2を推奨
- **50ms前後**: どちらでも可
- **50ms以上**: HTTP/3を推奨（ただし差はわずか）

### 最終推奨

**ハイブリッド運用が最適解:**
1. HTTP/3を提供（将来性・機能性）
2. HTTP/2をフォールバック（互換性・安定性）
3. クライアントに自動選択させる

**条件:**
- 複数ファイル転送ならHTTP/3の優位性が拡大する可能性
- モバイル環境ならHTTP/3のコネクション移行が有効
- パケット損失環境ならHTTP/3の再送制御が優位

---

## 今後の研究課題

1. 複数ストリーム並列転送での比較
2. パケット損失環境（1%, 5%, 10%）での評価
3. ファイルサイズ別の詳細分析
4. 0-RTTハンドシェイクの効果測定
5. コネクション移行の実装・評価
6. Linux環境での再実験
7. 実WANネットワークでの検証

