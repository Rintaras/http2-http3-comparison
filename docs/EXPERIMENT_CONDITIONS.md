# 実験条件の詳細

## 1. 実験の目的

HTTP/2とHTTP/3の性能特性を、様々なネットワーク条件下で比較し、それぞれのプロトコルの長所・短所を定量的に評価する。

---

## 2. 実験環境

### 2.1 ハードウェア/OS環境
- **OS**: macOS Darwin 25.1.0
- **Docker**: Docker Desktop for Mac
- **シェル**: /bin/zsh
- **日付**: 2025年10月1日

### 2.2 ソフトウェアスタック

#### サーバー側
- **言語**: Go 1.21
- **HTTP/3ライブラリ**: quic-go v0.40.1
- **HTTP/2ライブラリ**: golang.org/x/net/http2
- **ベースイメージ**: Ubuntu 22.04
- **TLS**: localhost+2証明書（mkcertで生成）
- **プロトコル対応**: HTTP/1.1, HTTP/2, HTTP/3 (同一ポート8443)

#### クライアント側
- **HTTP/2クライアント**: curl (--http2オプション)
- **HTTP/3クライアント**: Go 1.21 + quic-go v0.40.1 (カスタム実装)
  - curlがHTTP/3未対応のため独自実装

#### ネットワーク制御
- **ルーター**: Goベースのプロキシ (TCP/UDP対応)
- **トラフィック制御**: Linux tc (Traffic Control) コマンド
  - **HTB (Hierarchical Token Bucket)**: 帯域制限
  - **netem (Network Emulator)**: 遅延・パケット損失エミュレーション
- **ツール**: iproute2パッケージ

---

## 3. ネットワーク構成

### 3.1 アーキテクチャ

```
[クライアント (localhost)]
        ↓
[ネットワークルーター (Docker Container)]
    ├─ TCP Proxy :8444 → HTTP/2通信
    └─ UDP Proxy :8443 → HTTP/3通信
        ↓
    [tc トラフィック制御 (eth0)]
        ├─ HTB qdisc: 帯域制限
        └─ netem qdisc: 遅延・パケット損失
        ↓
[HTTP/3サーバー (Docker Container) :8443]
    ├─ HTTP/1.1
    ├─ HTTP/2 (ALPN: h2)
    └─ HTTP/3 (ALPN: h3)
```

### 3.2 Docker ネットワーク
- **ネットワーク名**: protocol_comparison_protocol_net
- **ネットワークタイプ**: bridge
- **コンテナ間通信**: 内部DNS解決
- **外部アクセス**: ポートマッピング

### 3.3 TLS設定
- **証明書**: mkcert生成 (localhost, 127.0.0.1, ::1)
- **TLS処理**: 
  - HTTP/2: ルーターでTLSパススルー（終端なし）
  - HTTP/3: サーバーで終端
- **証明書検証**: テストのため無効化 (InsecureSkipVerify)

---

## 4. トラフィック制御の詳細

### 4.1 tcコマンドの設定

#### HTB (帯域制限)
```bash
tc qdisc add dev eth0 root handle 1: htb default 10
tc class add dev eth0 parent 1: classid 1:10 htb rate <BANDWIDTH>
```

**設定可能な帯域:**
- 1mbit (1 Mbps = 125 KB/s)
- 5mbit (5 Mbps = 625 KB/s)
- 10mbit (10 Mbps = 1.25 MB/s)
- 100mbit (100 Mbps = 12.5 MB/s) - 制限なしに相当

#### netem (遅延・パケット損失)
```bash
tc qdisc add dev eth0 parent 1:10 handle 10: netem delay <LATENCY> loss <LOSS>
```

**設定可能なパラメータ:**
- 遅延: 0ms, 25ms, 50ms, 75ms, 100ms, 125ms, 150ms, 175ms, 200ms
- パケット損失: 0%, 1%, 5%, 10%

### 4.2 トラフィック制御の特徴

**カーネルレベル制御:**
- アプリケーション層より正確
- すべてのパケットに均等に適用
- TCP/UDPの両方に同じ条件を適用

**制御粒度:**
- パケット単位での制御
- バースト許容あり（HTBのバケットサイズ）
- 確率的パケット損失（netem）

---

## 5. 測定条件

### 5.1 転送データ
- **データサイズ**: 10MB (10,485,760 bytes)
- **生成方法**: `make([]byte, 10*1024*1024)` - ゼロ埋め
- **エンドポイント**: `/large`
- **Content-Type**: application/octet-stream

### 5.2 測定項目

#### 主要メトリクス
1. **転送時間 (秒)**: データ送信開始から完了まで
2. **実効速度 (KB/s, MB/s)**: データサイズ ÷ 転送時間
3. **成功率**: 成功試行数 ÷ 総試行数
4. **プロトコル**: レスポンスヘッダーから取得 (HTTP/2, HTTP/3.0)

#### 統計値
- 平均値 (Average)
- 中央値 (Median)
- 最小値 (Min)
- 最大値 (Max)
- 試行回数ごとの個別値

### 5.3 試行回数
- **基本**: 3-5回の反復測定
- **統計的信頼性**: 中央値・平均値で評価
- **異常値**: タイムアウト・エラーは別途記録

---

## 6. 実験シナリオ

### 6.1 テストケース

#### ケース1: 通常状態（ベースライン）
- **帯域**: 100mbit (実質制限なし)
- **遅延**: 0ms
- **パケット損失**: 0%
- **目的**: 最大性能の測定

#### ケース2: 低帯域環境
- **帯域**: 1mbit
- **遅延**: 0ms
- **パケット損失**: 0%
- **目的**: 帯域制約下での比較（モバイル3G相当）

#### ケース3: 中帯域環境
- **帯域**: 5mbit
- **遅延**: 0ms
- **パケット損失**: 0%
- **目的**: 一般的なモバイル環境での比較

#### ケース4: 遅延環境（中程度）
- **帯域**: 10mbit
- **遅延**: 50ms
- **パケット損失**: 0%
- **目的**: RTTの影響を評価（国内ネットワーク相当）

#### ケース5: 遅延環境（大）
- **帯域**: 10mbit
- **遅延**: 100ms
- **パケット損失**: 0%
- **目的**: 長距離通信の影響を評価（国際ネットワーク相当）

#### ケース6: 不安定ネットワーク
- **帯域**: 10mbit
- **遅延**: 50ms
- **パケット損失**: 1%
- **目的**: パケット損失環境での再送制御の評価

#### ケース7: 劣悪ネットワーク
- **帯域**: 10mbit
- **遅延**: 50ms
- **パケット損失**: 5%
- **目的**: 高損失環境でのQUICの優位性を検証

### 6.2 実験手順

1. **環境準備**
   ```bash
   docker-compose -f docker-compose.router_tc.yml down
   ```

2. **条件設定**
   ```bash
   BANDWIDTH=10mbit LATENCY=50ms LOSS=0% \
     docker-compose -f docker-compose.router_tc.yml up -d
   ```

3. **tc設定確認**
   ```bash
   docker exec network-router tc qdisc show dev eth0
   ```

4. **HTTP/3測定**
   ```bash
   docker run --rm --network protocol_comparison_protocol_net \
     -e TARGET_URL=https://network-router:8443/large \
     http3-test "./http3_test" "5"
   ```

5. **HTTP/2測定**
   ```bash
   curl -k --http2 https://localhost:8444/large -o /dev/null \
     -w "時間: %{time_total}s\n速度: %{speed_download} bytes/sec\n"
   ```

6. **環境リセット**
   ```bash
   docker-compose -f docker-compose.router_tc.yml down
   ```

---

## 7. 制約事項と注意点

### 7.1 環境の制約

#### macOS固有の制限
- **sysctl設定**: UDP関連の一部設定が制限される
- **Docker for Mac**: VM経由のネットワークオーバーヘッドあり
- **ホストネットワーク**: 未対応（bridgeモードのみ）

#### UDPバッファサイズ
- **デフォルト**: 208 kiB
- **推奨**: 2048 kiB
- **実際**: 416 kiB（部分的に増加）
- **影響**: HTTP/3の性能にわずかに影響（警告のみ）

### 7.2 測定の限界

#### 精度
- **時間分解能**: マイクロ秒単位
- **ネットワーク変動**: Docker内部ネットワークの変動あり
- **同時実行**: 他のDockerプロセスの影響を受ける可能性

#### 再現性
- **Docker再起動**: コンテナ再起動で若干の変動
- **tcタイミング**: tc設定直後は安定するまで数秒必要
- **キャッシュ**: Dockerイメージキャッシュの影響

### 7.3 プロトコル固有の注意

#### HTTP/3 (QUIC)
- **0-RTTハンドシェイク**: 今回は未使用（初回接続のみ）
- **コネクション移行**: 未検証
- **マルチパス**: 未対応
- **輻輳制御**: QUIC標準のCubic使用

#### HTTP/2
- **多重化**: 今回は単一リクエストのみ
- **HOLブロッキング**: パケット損失時に顕著
- **ストリーム優先度**: 未使用

---

## 8. 測定の信頼性向上策

### 8.1 実装した最適化

1. **Dockerリソース制限**
   - CPU固定: `cpuset: "0"`
   - CPU優先度: `cpu_shares: 2048`
   - ファイルディスクリプタ: `nofile: 65536`

2. **Go runtime最適化**
   - GC無効化: `debug.SetGCPercent(-1)`（ベンチマーク時）
   - プロセス優先度: `syscall.Setpriority()`
   - 単一スレッド: `GOMAXPROCS=1`（一部テスト）

3. **ネットワーク最適化**
   - IPv6無効化: ネットワークスタック簡素化
   - DNS解決最適化: Docker内部DNS使用
   - TLSセッション再利用: Keep-Alive有効

### 8.2 統計処理

- **複数回試行**: 3-5回の測定で平均と中央値を算出
- **外れ値検出**: タイムアウトは別途記録
- **ばらつき記録**: 最小・最大値も記録

---

## 9. 実験の妥当性

### 9.1 制御変数
- **同一サーバー**: HTTP/2とHTTP/3は同じサーバーコード
- **同一データ**: 10MBのデータは同一生成方法
- **同一ネットワーク**: tcで両プロトコルに同じ条件を適用
- **同一環境**: 同じDockerネットワーク内で実行

### 9.2 評価の公平性
- **プロトコルネイティブ実装**: 
  - HTTP/2: Go標準ライブラリ
  - HTTP/3: 公式quic-goライブラリ
- **証明書検証無効化**: 両方とも同じ設定
- **タイムアウト設定**: 両方とも120秒

### 9.3 実環境との差異
- **Dockerオーバーヘッド**: 実環境より若干遅い可能性
- **ローカルループバック**: WAN環境とは特性が異なる
- **シミュレーション**: 実ネットワークの変動を完全には再現できない

---

## 10. 今後の改善点

### 10.1 測定条件の拡張
- [ ] より多様な帯域設定（0.5Mbps, 20Mbps, 50Mbpsなど）
- [ ] 変動する帯域のシミュレーション
- [ ] ジッター（遅延の変動）の追加
- [ ] より高いパケット損失率（10%, 20%）

### 10.2 測定項目の追加
- [ ] CPU使用率の測定
- [ ] メモリ使用量の測定
- [ ] ハンドシェイク時間の分離測定
- [ ] 再送回数のカウント

### 10.3 プロトコル機能の検証
- [ ] HTTP/2のストリーム多重化
- [ ] HTTP/3の0-RTTハンドシェイク
- [ ] コネクション移行（Network Migration）
- [ ] 並列ダウンロードの比較

### 10.4 環境の改善
- [ ] Linux環境での実験（macOS制約の解消）
- [ ] 物理マシン間の実験（Dockerオーバーヘッド除去）
- [ ] 実WAN環境でのテスト
- [ ] クラウド環境での大規模テスト

