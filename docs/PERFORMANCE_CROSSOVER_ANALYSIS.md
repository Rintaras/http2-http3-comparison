# 性能逆転地点の分析: 実機環境 vs Docker環境

## 概要

実機環境とDocker環境で、HTTP/2とHTTP/3の性能逆転地点に大きな違いが確認されました。

## 測定結果の比較

### 実機環境（20251001_211526）

| 遅延 | HTTP/2平均 | HTTP/3平均 | 優位性 | 差 |
|------|-----------|-----------|--------|-----|
| 0ms  | 1.761s    | 1.888s    | HTTP/2 | +7.2% |
| 50ms | 2.169s    | 2.166s    | HTTP/3 | -0.1% |
| 100ms| 2.608s    | 2.568s    | HTTP/3 | -1.5% |
| 150ms| 3.056s    | 3.060s    | HTTP/2 | +0.1% |

**逆転地点**: 約**45-50ms**（0msと50msの間で推定）

### Docker環境（20251102_184146: 詳細測定）

| 遅延 | HTTP/2平均 | HTTP/3平均 | 優位性 | 差 |
|------|-----------|-----------|--------|-----|
| 0ms  | 1.747s    | 1.795s    | HTTP/2 | +2.7% |
| 1ms  | 1.828s    | 1.800s    | HTTP/3 | -1.6% |
| 2ms  | 1.841s    | 1.795s    | HTTP/3 | -2.5% |
| 50ms | 2.444s    | 2.041s    | HTTP/3 | -16.5% |

**逆転地点**: 約**0.6ms**（0msと1msの間で補間）

## 問題点

### 逆転地点の違い

- **実機環境**: 約45-50msで逆転
- **Docker環境**: 約0.6msで逆転
- **差**: 約**44-49ms早く逆転**

### HTTP/2の遅延増加率の違い

**実機環境（0ms→50ms）**:
- HTTP/2: +23.2% (1.761s → 2.169s)
- HTTP/3: +14.7% (1.888s → 2.166s)

**Docker環境（0ms→50ms）**:
- HTTP/2: +39.9% (1.747s → 2.444s)
- HTTP/3: +13.8% (1.795s → 2.041s)

Docker環境では、HTTP/2の遅延増加率が実機環境より約1.7倍大きい。

## 考えられる原因

### 1. ネットワーク遅延適用方法の違い

**実機環境**:
- サーバー側のNIC（eth0）に直接tc設定を適用
- クライアント→サーバーの直接通信

**Docker環境**:
- ルーターコンテナ（network-router）とサーバーコンテナ（http3-server）の両方でtc設定
- クライアント→ルーター→サーバーの2段階通信
- Dockerブリッジネットワーク経由

### 2. プロキシルーターによる追加オーバーヘッド

- HTTP/2（TCP）: ルーター経由でのプロキシ処理
- HTTP/3（UDP）: ルーター経由でのUDP転送
- ルーターのバッファリングとコピー処理による追加遅延

### 3. ネットワークスタックの違い

- **実機**: 物理NIC → カーネルネットワークスタック
- **Docker**: 仮想NIC → Dockerブリッジ → ホストNIC → カーネルネットワークスタック

### 4. TCP vs QUICのハンドシェイク特性の違い

Docker環境では、以下の理由でHTTP/3の優位性が早く現れる可能性：

- **TCP/HTTP/2**: ルーター経由でのプロキシ処理により、接続確立のオーバーヘッドが増大
- **QUIC/HTTP/3**: UDPの特性により、ルーター経由でもオーバーヘッドが比較的小さい

## 推奨事項

### 1. Docker環境の調整（実機環境に近づける）

#### A. ルーター経由を避ける方法
- クライアントから直接サーバーコンテナに接続
- ただし、これだとtc制御が困難

#### B. ルーターのオーバーヘッドを最小化
- バッファサイズの最適化
- プロキシ処理の最適化
- TCP_NODELAYの適用（既に実装済み）

#### C. 遅延適用方法の統一
- サーバー側のみでtc設定を適用（実機と同じ）
- ルーター側のtc設定を見直す

### 2. 測定方法の見直し

- 実機環境でも1-50ms範囲の詳細測定を実施して、正確な逆転地点を特定
- Docker環境でもサーバー側のみでtc設定を適用する方法を検討

### 3. 考察

Docker環境では、ルーター経由のプロキシ処理により、HTTP/2のオーバーヘッドが増大し、結果としてHTTP/3の優位性が早く現れる可能性が高い。

実機環境では、直接通信によりHTTP/2の性能が保たれ、より高遅延（45-50ms）になってからHTTP/3が優位になる。

## 結論

Docker環境と実機環境で性能逆転地点が大きく異なる主な原因は、**ネットワークアーキテクチャの違い**（ルーター経由 vs 直接通信）と考えられます。

実機環境の測定結果がより現実的なネットワーク条件を反映している可能性が高いです。
