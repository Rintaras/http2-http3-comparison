# ベンチマークデータ品質比較: 20251001 vs 20251024

## 概要

2025-10-01の実機ベンチマークと、2025-10-24のDocker環境ベンチマークで、**重大な差異が存在します**。

---

## 主要な違い

### 1. 実通信データサイズ（最も重要）

#### 20251001_211526（実機環境）✅
```
通信時間: 1.873秒
転送速度: 546.64 kbps
転送量: 1.873 × 546.64 = 1023.86 KB ≈ 1MB
```

**評価**: ✅ **実機で実際に1MBを転送**（正しい測定）

#### docker_20251024_233734（Docker環境）❌
```
通信時間: 0.012429秒
転送速度: 2.33 kbps
転送量: 0.012429 × 2.33 = 0.029 KB ≈ 30 bytes
```

**評価**: ❌ **実際にはほぼデータを転送していない**（不適切な測定）

---

### 2. データポイント数

| 環境 | 行数 | 遅延条件 | 評価 |
|------|------|---------|------|
| 20251001実機 | 400行 | 0-150ms全範囲 | ✅ 包括的 |
| docker新 | 160行 | 2/50/100/150ms | ❌ 限定的 |

---

### 3. 遅延条件

#### 20251001_211526
```
0ms, 1ms, 2ms, 3ms, ..., 149ms, 150ms（全151条件）
```
→ **実際のネットワーク環境（リアル）**

#### docker_20251024_233734
```
2ms, 50ms, 100ms, 150ms（4条件のみ）
```
→ **サンプリング的なアプローチ**

---

## なぜこのような違いが生じたか？

### Docker環境の問題

#### 推定原因1: ファイルサイズの誤設定

**実機**:
- `/1mb` エンドポイント → 実際に1MBのファイル

**Docker**:
- ルーター設定で1MBのファイルが正しく供給されていない？
- ローカルループバック内での転送（小規模）

#### 推定原因2: ネットワークルーターの内部動作

Dockerのルーター（`Dockerfile.router_tc`）では：
- TCP Proxy: `8444 → server:8443`
- UDP Proxy: `8443 → server:8443`

これらのプロキシ経由では、実際のファイル転送が制限されている可能性があります。

#### 推定原因3: `tc`（トラフィック制御）の影響

Dockerでの`tc`設定:
```bash
./tc_setup.sh eth0 100mbit "2ms" 0%
```

これにより、遅延制御が転送サイズに影響を与えた可能性があります。

---

## 性能差から見える真実

### 20251001_211526（実機）
```
HTTP/3: 平均 2.0秒
HTTP/2: 平均 2.1秒
改善率: 5.5%（現実的）
```

### docker_20251024_233734（Docker）
```
HTTP/3: 平均 0.013秒
HTTP/2: 平均 0.031秒
改善率: 58%（異常に高い）
```

**評価**:
- 実機の5.5%改善 → 信頼できる（実測データ）
- Docker の58%改善 → 疑わしい（非実測データ）

---

## 推奨事項

### 1. 実機ベンチマーク（20251001パターン）の復元

20251001_211526の実装に戻すことを推奨：
- ✅ 0-150msの全範囲をテスト
- ✅ 実際に1MBを転送
- ✅ 実測に基づく信頼性の高いデータ

### 2. Docker環境の修正（今後のため）

Docker環境でも実機と同等のデータが得られるよう：
- [ ] ファイルサイズ設定の確認
- [ ] ルーターのプロキシ設定の検証
- [ ] tc設定の最適化
- [ ] 全遅延条件での測定

### 3. ベンチマーク検証基準の確立

今後のベンチマークでは：
- [ ] 転送データサイズの検証（計算確認）
- [ ] 転送時間の妥当性チェック（1MBなら1-2秒程度）
- [ ] 遅延条件の包括性確認

---

## 結論

**20251001_211526のデータが信頼できる理由**:
1. ✅ 実際に1MBのデータを転送している
2. ✅ リアルなネットワーク環境（0-150ms全範囲）
3. ✅ 通信時間が物理的に妥当（1.8-2.0秒）
4. ✅ プロトコル間の性能差が現実的（5-10%程度）

**docker_20251024のデータの問題**:
1. ❌ 実際には数十バイト程度しか転送していない
2. ❌ 測定が非現実的（0.01秒）
3. ❌ 性能差が異常に大きい（50%以上）
4. ❌ Docker環境の設定に問題がある

**推奨**: 実機環境の20251001_211526パターンでのベンチマーク実行が推奨されます。

