# HTTP/3 vs HTTP/2 性能比較結果

## テスト環境

- **サーバー**: Go 1.21 + quic-go v0.40.1
- **ルーター**: tcコマンドによるトラフィック制御
- **転送データサイズ**: 10MB
- **プロトコル**: HTTP/2 (TCP/TLS) vs HTTP/3 (QUIC/UDP)

## テスト結果

### 1. 通常状態（帯域制限なし）

| プロトコル | 転送時間 | 実効速度 | 備考 |
|-----------|---------|---------|------|
| **HTTP/3** | 0.930秒 | 11,009 KB/s | - |
| **HTTP/2** | 0.93-0.98秒 | 10,658-11,256 KB/s | 平均: 約11,000 KB/s |

**結果**: ほぼ同等の性能。HTTP/3は安定して0.93秒を記録。

---

### 2. 帯域制限 1Mbps

| プロトコル | 転送時間 | 実効速度 | 備考 |
|-----------|---------|---------|------|
| **HTTP/3** | 90.578秒 | 113 KB/s | 帯域制限に従った転送 |
| **HTTP/2** | 87.724秒 | 119 KB/s | HTTP/3より約3%高速 |

**結果**: 低帯域環境ではHTTP/2がわずかに優位。

---

### 3. 帯域制限 10Mbps + 遅延 50ms

| プロトコル | 試行1 | 試行2 | 試行3 | 平均速度 | 備考 |
|-----------|------|------|------|---------|------|
| **HTTP/3** | 9.514秒<br>1,076 KB/s | 9.472秒<br>1,081 KB/s | 18.576秒<br>551 KB/s | 約903 KB/s | 3回目で大幅な遅延 |
| **HTTP/2** | 13.980秒<br>750 KB/s | 11.266秒<br>930 KB/s | 11.215秒<br>934 KB/s | 約871 KB/s | 1回目で遅延、その後安定 |

**結果**: 遅延環境では両プロトコルともばらつきが大きい。HTTP/3は初期接続が高速だが、タイムアウトリスクあり。

---

## 総合評価

### HTTP/3の特徴

**長所:**
- ✅ 通常状態では HTTP/2 と同等の性能
- ✅ 初期接続が高速（ハンドシェイク統合）
- ✅ 遅延環境での初期2回の試行は高速（9.5秒）

**短所:**
- ❌ 低帯域環境（1Mbps）でわずかに劣る
- ❌ タイムアウトが発生する場合がある
- ⚠️ UDPバッファサイズの調整が必要
- ⚠️ 一部のネットワークでUDPが制限される可能性

### HTTP/2の特徴

**長所:**
- ✅ 安定した転送性能
- ✅ 低帯域環境でわずかに優位
- ✅ 既存インフラで広くサポート

**短所:**
- ❌ 初期接続時のハンドシェイクオーバーヘッド
- ❌ HOL（Head-of-Line）ブロッキング問題

---

## 結論

### ネットワーク条件別の推奨

| ネットワーク条件 | 推奨プロトコル | 理由 |
|----------------|--------------|------|
| **高帯域・低遅延** | HTTP/3 = HTTP/2 | 同等の性能 |
| **低帯域（1Mbps以下）** | HTTP/2 | 約3%高速 |
| **遅延あり（50ms+）** | HTTP/3 | 初期接続が高速だが不安定 |
| **パケット損失あり** | HTTP/3 | 理論上優位（QUIC の再送制御） |

### 実装上の考慮事項

1. **HTTP/3の導入:**
   - UDPバッファサイズの調整が必須
   - タイムアウト設定の最適化が必要
   - ファイアウォール/ルーターのUDP許可確認

2. **HTTP/2の継続利用:**
   - 安定性重視の場合は現状維持が妥当
   - TCPベースのため既存インフラで確実に動作

3. **ハイブリッド運用:**
   - Alt-SvcヘッダーでHTTP/3を提案
   - HTTP/2をフォールバックとして維持
   - クライアントが自動的に最適なプロトコルを選択

---

## 技術的発見

### tcコマンドによるネットワーク制御の有効性

- **HTB qdisc**: 帯域制限が正確に機能
- **netem**: 遅延エミュレーションが効果的に動作
- **カーネルレベル制御**: アプリケーション層より正確

### QUIC/HTTP/3の課題

- UDP受信バッファサイズの警告（208 kiB → 2048 kiB）
- タイムアウト発生時の再試行ロジックが必要
- ネットワーク変動に対する耐性が課題

---

## 今後の検証項目

1. **パケット損失環境でのテスト**: 1%, 5%, 10%
2. **並列接続のテスト**: 複数ストリームの同時転送
3. **ファイルサイズ別の比較**: 1KB, 100KB, 1MB, 100MB
4. **モバイルネットワークシミュレーション**: 変動する帯域と遅延
5. **コネクション再利用**: Keep-Alive vs QUIC Connection Migration


